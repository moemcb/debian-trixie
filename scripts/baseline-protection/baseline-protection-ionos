#!/bin/bash
###############################################################################
# VPS Security Hardening Script for Debian 13 Trixie
# Designed for VPS servers using Cloudflare Tunnels
#
# Usage: sudo ./vps-harden.sh [TUNNEL_IP]
# Example: sudo ./vps-harden.sh 10.0.0.1
#
# This script should be run with root privileges
#
# WARNING: Always test on a non-production server first!
# WARNING: Ensure you have console/rescue access to your VPS before running!
# WARNING: The script will restart SSH - ensure you can access via console!
###############################################################################


set -e  # Exit on error
set -u  # Exit on undefined variable

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
TUNNEL_IP="${1:-10.0.0.1}"  # Cloudflare tunnel IP (default: 10.0.0.1)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_FILE="/var/log/vps-hardening-$(date +%Y%m%d-%H%M%S).log"
BACKUP_DIR="/root/security-backup-$(date +%Y%m%d-%H%M%S)"

# Logging function
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $*" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $*" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*" | tee -a "$LOG_FILE"
}

log_section() {
    echo -e "\n${BLUE}========================================${NC}" | tee -a "$LOG_FILE"
    echo -e "${BLUE}$*${NC}" | tee -a "$LOG_FILE"
    echo -e "${BLUE}========================================${NC}" | tee -a "$LOG_FILE"
}

# Check if running as root
if [[ $EUID -ne 0 ]]; then
   log_error "This script must be run as root"
   exit 1
fi

log "VPS Hardening Script Starting"
log "Cloudflare Tunnel IP: $TUNNEL_IP"
log "Log file: $LOG_FILE"

# Create backup directory
mkdir -p "$BACKUP_DIR"
log "Backup directory: $BACKUP_DIR"

###############################################################################
# 1. CONFIGURE SECURITY REPOSITORIES
###############################################################################
log_section "1. Configuring Debian Security Repositories"

# Ensure security repositories are present
if [ -f /etc/apt/sources.list ]; then
    cp /etc/apt/sources.list "$BACKUP_DIR/sources.list.bak"
fi

# Add Debian security repository if not present
if ! grep -q "deb.debian.org/debian-security" /etc/apt/sources.list /etc/apt/sources.list.d/* 2>/dev/null; then
    log "Adding Debian security repository..."
    cat >> /etc/apt/sources.list << 'EOF'

# Debian Security Repository
deb http://deb.debian.org/debian-security trixie-security main contrib non-free non-free-firmware
deb-src http://deb.debian.org/debian-security trixie-security main contrib non-free non-free-firmware
EOF
    log "Debian security repository added"
else
    log "Debian security repository already configured"
fi

###############################################################################
# 2. SYSTEM UPDATE
###############################################################################
log_section "2. Updating System Packages"

apt update 2>&1 | tee -a "$LOG_FILE"
apt upgrade -y 2>&1 | tee -a "$LOG_FILE"
apt dist-upgrade -y 2>&1 | tee -a "$LOG_FILE"
apt autoremove -y 2>&1 | tee -a "$LOG_FILE"
apt autoclean -y 2>&1 | tee -a "$LOG_FILE"

log "System packages updated successfully"

###############################################################################
# 3. INSTALL ESSENTIAL SECURITY PACKAGES
###############################################################################
log_section "3. Installing Security Packages"

SECURITY_PACKAGES=(
    "ufw"                    # Firewall
    "fail2ban"               # Intrusion prevention
    "apparmor"               # Mandatory access control
    "apparmor-utils"         # AppArmor utilities
    "auditd"                 # Audit daemon
    "aide"                   # File integrity checker
    "lynis"                  # Security auditing tool
    "unattended-upgrades"    # Automatic security updates
    "apt-listchanges"        # Package change notifications
    "needrestart"            # Service restart notifications
    "debsums"                # Package integrity verification
    "libpam-tmpdir"          # Per-user temporary directories
    "libpam-pwquality"       # Password quality checking
    "rkhunter"               # Rootkit detection
    "acct"                   # Process accounting
    "apt-show-versions"      # Package version management
)

log "Installing security packages: ${SECURITY_PACKAGES[*]}"
apt install -y "${SECURITY_PACKAGES[@]}" 2>&1 | tee -a "$LOG_FILE"

log "Security packages installed successfully"

###############################################################################
# 4. KERNEL MODULE BLACKLISTING
###############################################################################
log_section "4. Blacklisting Unnecessary Kernel Modules"

# Blacklist unused/dangerous protocols
cat > /etc/modprobe.d/blacklist-security.conf << 'EOF'
# Disable uncommon network protocols (security hardening)
install dccp /bin/true
install sctp /bin/true
install rds /bin/true
install tipc /bin/true
install n-hdlc /bin/true
install ax25 /bin/true
install netrom /bin/true
install x25 /bin/true
install rose /bin/true
install decnet /bin/true
install econet /bin/true
install af_802154 /bin/true
install ipx /bin/true
install appletalk /bin/true
install psnap /bin/true
install p8023 /bin/true
install llc /bin/true
install p8022 /bin/true

# Disable uncommon filesystems
install cramfs /bin/true
install freevxfs /bin/true
install jffs2 /bin/true
install hfs /bin/true
install hfsplus /bin/true
install udf /bin/true

# Disable USB storage (uncomment if needed)
# install usb-storage /bin/true

# Disable Firewire (uncomment if needed)
# install firewire-core /bin/true
EOF

log "Kernel modules blacklisted"

###############################################################################
# 5. KERNEL HARDENING (SYSCTL)
###############################################################################
log_section "5. Applying Kernel Hardening Parameters"

# Backup existing sysctl configuration if it exists
if [ -f /etc/sysctl.conf ]; then
    cp /etc/sysctl.conf "$BACKUP_DIR/sysctl.conf.bak"
    log "Backed up existing /etc/sysctl.conf"
else
    log_warning "/etc/sysctl.conf not found, skipping backup"
fi

# Create security-focused sysctl configuration
cat > /etc/sysctl.d/99-security.conf << 'EOF'
# IP Forwarding (disabled for security)
net.ipv4.ip_forward = 0
net.ipv6.conf.all.forwarding = 0

# SYN Cookies protection against SYN flood attacks
net.ipv4.tcp_syncookies = 1

# Reverse path filtering (prevent IP spoofing)
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Do not accept ICMP redirects (prevent MITM attacks)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# Do not send ICMP redirects
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Do not accept IP source route packets
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# Log Martian Packets (packets with impossible addresses)
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Ignore ICMP ping requests
net.ipv4.icmp_echo_ignore_all = 0
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Ignore bogus ICMP error responses
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Enable TCP/IP stack hardening
net.ipv4.tcp_rfc1337 = 1
net.ipv4.tcp_timestamps = 0

# Kernel hardening
kernel.dmesg_restrict = 1
kernel.kptr_restrict = 2
kernel.yama.ptrace_scope = 2
kernel.unprivileged_bpf_disabled = 1
net.core.bpf_jit_harden = 2

# Address Space Layout Randomization (ASLR)
kernel.randomize_va_space = 2

# Restrict kernel logs
kernel.printk = 3 3 3 3

# Restrict access to kernel pointers
kernel.kexec_load_disabled = 1

# Disable IPv6 (not needed with Cloudflare tunnel-only access)
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1

# Increase system file descriptor limit
fs.file-max = 65535

# Protect hard and symbolic links
fs.protected_hardlinks = 1
fs.protected_symlinks = 1
fs.protected_regular = 2
fs.protected_fifos = 2

# TCP hardening
# Note: SACK/DSACK/FACK disabling removed - kernel 6.12+ already patches CVE-2019-11477
# Disabling causes 8-25% performance degradation with no security benefit on patched kernels
EOF

# Apply sysctl settings
sysctl -p /etc/sysctl.d/99-security.conf 2>&1 | tee -a "$LOG_FILE"

log "Kernel hardening parameters applied"

###############################################################################
# 6. SSH HARDENING
###############################################################################
log_section "6. Hardening SSH Configuration"

# Backup SSH configuration
if [ -f /etc/ssh/sshd_config ]; then
    cp /etc/ssh/sshd_config "$BACKUP_DIR/sshd_config.bak"
    log "Backed up /etc/ssh/sshd_config"
fi

# Create hardened SSH configuration
cat > /etc/ssh/sshd_config.d/99-hardening.conf << EOF
# Listen only on Cloudflare tunnel IP
ListenAddress $TUNNEL_IP

# Protocol and encryption
Protocol 2
HostKey /etc/ssh/ssh_host_ed25519_key
HostKey /etc/ssh/ssh_host_rsa_key

# Security settings
PermitRootLogin prohibit-password
PasswordAuthentication no
PubkeyAuthentication yes
ChallengeResponseAuthentication no
UsePAM yes

# Disable insecure features
X11Forwarding no
PrintMotd no
PermitEmptyPasswords no
PermitUserEnvironment no
AllowAgentForwarding no
AllowTcpForwarding no
PermitTunnel no

# Authentication settings
MaxAuthTries 3
MaxSessions 2
LoginGraceTime 30

# Client alive interval (5 minutes timeout)
ClientAliveInterval 300
ClientAliveCountMax 2
TCPKeepAlive no

# Logging
SyslogFacility AUTH
LogLevel VERBOSE

# Strong ciphers only
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256

# Banner
Banner /etc/ssh/banner
EOF

# Create SSH banner
cat > /etc/ssh/banner << 'EOF'
################################################################################
#                        AUTHORIZED ACCESS ONLY                                #
#                                                                              #
# Unauthorized access to this system is forbidden and will be prosecuted by   #
# law. By accessing this system, you agree that your actions may be monitored. #
################################################################################
EOF

# Validate SSH configuration
if sshd -t 2>&1 | tee -a "$LOG_FILE"; then
    log "SSH configuration is valid"
else
    log_error "SSH configuration validation failed. Restoring backup."
    rm /etc/ssh/sshd_config.d/99-hardening.conf
    exit 1
fi

log "SSH hardening completed"

###############################################################################
# 7. FIREWALL CONFIGURATION (UFW)
###############################################################################
log_section "7. Configuring Firewall (UFW)"

# Reset UFW to default state
ufw --force reset 2>&1 | tee -a "$LOG_FILE"

# Set default policies
ufw default deny incoming 2>&1 | tee -a "$LOG_FILE"
ufw default allow outgoing 2>&1 | tee -a "$LOG_FILE"
ufw default deny routed 2>&1 | tee -a "$LOG_FILE"

# Allow SSH only from Cloudflare tunnel IP
ufw allow from any to "$TUNNEL_IP" port 22 proto tcp comment 'SSH via Cloudflare Tunnel' 2>&1 | tee -a "$LOG_FILE"

# Allow loopback
ufw allow in on lo 2>&1 | tee -a "$LOG_FILE"
ufw allow out on lo 2>&1 | tee -a "$LOG_FILE"

# Enable UFW
ufw --force enable 2>&1 | tee -a "$LOG_FILE"

# Configure UFW logging
ufw logging medium 2>&1 | tee -a "$LOG_FILE"

log "Firewall configured successfully"
ufw status verbose 2>&1 | tee -a "$LOG_FILE"

###############################################################################
# 8. FAIL2BAN CONFIGURATION
###############################################################################
log_section "8. Configuring Fail2ban"

# Backup fail2ban configuration
if [ -f /etc/fail2ban/jail.local ]; then
    cp /etc/fail2ban/jail.local "$BACKUP_DIR/jail.local.bak"
fi

# Configure fail2ban
cat > /etc/fail2ban/jail.local << EOF
[DEFAULT]
# Ban settings
bantime = 3600
findtime = 600
maxretry = 3
destemail = root@localhost
sendername = Fail2Ban
action = %(action_mwl)s

# Ignore localhost and Cloudflare tunnel
ignoreip = 127.0.0.1/8 ::1 $TUNNEL_IP

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600

[sshd-ddos]
enabled = true
port = ssh
filter = sshd-ddos
logpath = /var/log/auth.log
maxretry = 2
bantime = 7200
EOF

# Start and enable fail2ban
systemctl enable fail2ban 2>&1 | tee -a "$LOG_FILE"
systemctl restart fail2ban 2>&1 | tee -a "$LOG_FILE"

log "Fail2ban configured and started"

###############################################################################
# 9. APPARMOR CONFIGURATION
###############################################################################
log_section "9. Configuring AppArmor"

# Enable AppArmor
systemctl enable apparmor 2>&1 | tee -a "$LOG_FILE"
systemctl start apparmor 2>&1 | tee -a "$LOG_FILE"

# Set all profiles to enforce mode
aa-enforce /etc/apparmor.d/* 2>&1 | tee -a "$LOG_FILE" || true

log "AppArmor enabled and profiles set to enforce mode"
aa-status 2>&1 | tee -a "$LOG_FILE" || true

###############################################################################
# 10. AUDITD CONFIGURATION
###############################################################################
log_section "10. Configuring Audit Daemon (auditd)"

# Backup auditd rules
if [ -f /etc/audit/rules.d/audit.rules ]; then
    cp /etc/audit/rules.d/audit.rules "$BACKUP_DIR/audit.rules.bak"
fi

# Configure comprehensive audit rules
cat > /etc/audit/rules.d/hardening.rules << 'EOF'
# Delete all existing rules
-D

# Buffer size
-b 8192

# Failure mode (1 = print failure message)
-f 1

# Audit system calls
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
-a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change
-a always,exit -F arch=b64 -S clock_settime -k time-change
-a always,exit -F arch=b32 -S clock_settime -k time-change
-w /etc/localtime -p wa -k time-change

# User and group modifications
-w /etc/group -p wa -k identity
-w /etc/passwd -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/security/opasswd -p wa -k identity

# Network configuration changes
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k system-locale
-a always,exit -F arch=b32 -S sethostname -S setdomainname -k system-locale
-w /etc/issue -p wa -k system-locale
-w /etc/issue.net -p wa -k system-locale
-w /etc/hosts -p wa -k system-locale
-w /etc/network -p wa -k system-locale

# SELinux/AppArmor events
-w /etc/apparmor/ -p wa -k MAC-policy
-w /etc/apparmor.d/ -p wa -k MAC-policy

# Login/Logout events
-w /var/log/faillog -p wa -k logins
-w /var/log/lastlog -p wa -k logins
-w /var/log/tallylog -p wa -k logins

# Session initiation
-w /var/run/utmp -p wa -k session
-w /var/log/wtmp -p wa -k logins
-w /var/log/btmp -p wa -k logins

# Discretionary access control changes
-a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b64 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod

# Unauthorized file access attempts
-a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access

# Privileged command execution
-a always,exit -F path=/usr/bin/passwd -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-passwd
-a always,exit -F path=/usr/bin/sudo -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-sudo
-a always,exit -F path=/usr/bin/su -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-su

# File deletion by users
-a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete
-a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete

# Sudoers file changes
-w /etc/sudoers -p wa -k scope
-w /etc/sudoers.d/ -p wa -k scope

# Kernel module operations
-w /sbin/insmod -p x -k modules
-w /sbin/rmmod -p x -k modules
-w /sbin/modprobe -p x -k modules
-a always,exit -F arch=b64 -S init_module -S delete_module -k modules

# SSH configuration
-w /etc/ssh/sshd_config -p wa -k sshd
-w /etc/ssh/sshd_config.d/ -p wa -k sshd

# Make configuration immutable
-e 2
EOF

# Generate audit rules
augenrules --load 2>&1 | tee -a "$LOG_FILE"

# Restart auditd
systemctl enable auditd 2>&1 | tee -a "$LOG_FILE"
systemctl restart auditd 2>&1 | tee -a "$LOG_FILE"

log "Auditd configured and restarted"

###############################################################################
# 11. AUTOMATIC SECURITY UPDATES
###############################################################################
log_section "11. Configuring Automatic Security Updates"

# Configure unattended-upgrades
cat > /etc/apt/apt.conf.d/50unattended-upgrades << 'EOF'
Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}";
    "${distro_id}:${distro_codename}-security";
    "${distro_id}ESMApps:${distro_codename}-apps-security";
    "${distro_id}ESM:${distro_codename}-infra-security";
};

Unattended-Upgrade::Package-Blacklist {
};

Unattended-Upgrade::AutoFixInterruptedDpkg "true";
Unattended-Upgrade::MinimalSteps "true";
Unattended-Upgrade::InstallOnShutdown "false";
Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
Unattended-Upgrade::Remove-Unused-Dependencies "true";
Unattended-Upgrade::Automatic-Reboot "false";
Unattended-Upgrade::Automatic-Reboot-Time "03:00";
Unattended-Upgrade::SyslogEnable "true";
Unattended-Upgrade::SyslogFacility "daemon";
EOF

# Enable automatic updates
cat > /etc/apt/apt.conf.d/20auto-upgrades << 'EOF'
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Download-Upgradeable-Packages "1";
APT::Periodic::AutocleanInterval "7";
APT::Periodic::Unattended-Upgrade "1";
EOF

log "Automatic security updates configured"

###############################################################################
# 12. PASSWORD POLICIES
###############################################################################
log_section "12. Configuring Password Policies"

# Backup PAM configuration
if [ -f /etc/pam.d/common-password ]; then
    cp /etc/pam.d/common-password "$BACKUP_DIR/common-password.bak"
    log "Backed up /etc/pam.d/common-password"
fi

if [ -f /etc/login.defs ]; then
    cp /etc/login.defs "$BACKUP_DIR/login.defs.bak"
    log "Backed up /etc/login.defs"
fi

# Configure password quality requirements
cat > /etc/security/pwquality.conf << 'EOF'
# Password quality requirements (NIST SP 800-63B-4 compliant)
# Note: NIST 2025 recommends NO complexity rules, longer minimum length
minlen = 15
minclass = 0
maxrepeat = 3
maxclassrepeat = 4
lcredit = -1
ucredit = -1
dcredit = -1
ocredit = -1
difok = 5
gecoscheck = 1
dictcheck = 1
usercheck = 1
enforcing = 1
retry = 3
EOF

# Configure password aging (NIST 2025: no periodic expiration required)
sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   99999/' /etc/login.defs
sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   1/' /etc/login.defs
sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   7/' /etc/login.defs

# Configure PAM password hashing rounds (SHA-512 with increased rounds)
if ! grep -q "SHA_CRYPT_MIN_ROUNDS" /etc/login.defs; then
    echo "" >> /etc/login.defs
    echo "# Password hashing rounds for SHA-512" >> /etc/login.defs
    echo "SHA_CRYPT_MIN_ROUNDS 5000" >> /etc/login.defs
    echo "SHA_CRYPT_MAX_ROUNDS 5000" >> /etc/login.defs
    log "Added SHA-512 password hashing rounds"
else
    log "SHA-512 hashing rounds already configured"
fi

# Set default umask to 027 (more restrictive)
if ! grep -q "^UMASK.*027" /etc/login.defs; then
    sed -i 's/^UMASK.*/UMASK\t\t027/' /etc/login.defs || echo "UMASK		027" >> /etc/login.defs
    log "Set default umask to 027"
fi

log "Password policies configured"

###############################################################################
# 13. COMPILER HARDENING
###############################################################################
log_section "13. Hardening Compilers"

# Restrict compiler access to root only
for compiler in /usr/bin/gcc* /usr/bin/g++* /usr/bin/cc /usr/bin/c++ /usr/bin/as /usr/bin/ld; do
    if [ -f "$compiler" ]; then
        chmod 750 "$compiler" 2>/dev/null || true
        log "Restricted access to $compiler"
    fi
done

log "Compiler hardening completed"

###############################################################################
# 14. PROCESS ACCOUNTING
###############################################################################
log_section "14. Enabling Process Accounting"

# Enable process accounting
if command -v accton &> /dev/null; then
    systemctl enable acct 2>&1 | tee -a "$LOG_FILE" || true
    systemctl start acct 2>&1 | tee -a "$LOG_FILE" || true
    log "Process accounting enabled"
else
    log_warning "Process accounting (acct) not available"
fi

###############################################################################
# 15. LEGAL BANNERS
###############################################################################
log_section "15. Configuring Legal Banners"

# Create /etc/issue banner
cat > /etc/issue << 'EOF'
################################################################################
#                        AUTHORIZED ACCESS ONLY                                #
#                                                                              #
# Unauthorized access to this system is forbidden and will be prosecuted by   #
# law. By accessing this system, you agree that your actions may be monitored. #
################################################################################

EOF

# Create /etc/issue.net banner
cat > /etc/issue.net << 'EOF'
################################################################################
#                        AUTHORIZED ACCESS ONLY                                #
#                                                                              #
# Unauthorized access to this system is forbidden and will be prosecuted by   #
# law. By accessing this system, you agree that your actions may be monitored. #
################################################################################
EOF

log "Legal banners configured"

###############################################################################
# 16. DISABLE UNNECESSARY SERVICES
###############################################################################
log_section "16. Disabling Unnecessary Services"

SERVICES_TO_DISABLE=(
    "avahi-daemon"
    "cups"
    "isc-dhcp-server"
    "isc-dhcp-server6"
    "bluetooth"
    "rpcbind"
    "rsync"
)

for service in "${SERVICES_TO_DISABLE[@]}"; do
    if systemctl is-enabled "$service" 2>/dev/null | grep -q enabled; then
        systemctl disable "$service" 2>&1 | tee -a "$LOG_FILE"
        systemctl stop "$service" 2>&1 | tee -a "$LOG_FILE"
        log "Disabled service: $service"
    fi
done

log "Unnecessary services disabled"

###############################################################################
# 17. AIDE CONFIGURATION (File Integrity Monitoring)
###############################################################################
log_section "17. Initializing AIDE (File Integrity Monitoring)"

# Configure AIDE with SHA256/SHA512
cat > /etc/aide/aide.conf.d/99-custom << 'EOF'
# Use SHA256 and SHA512 for checksums
Checksums = sha256+sha512

# Custom AIDE rules for VPS monitoring (using AppArmor, not SELinux)
/etc/ssh Checksums+p+i+n+u+g+s+b+acl+xattrs
/etc/sudoers Checksums+p+i+n+u+g+s+b+acl+xattrs
/etc/sudoers.d Checksums+p+i+n+u+g+s+b+acl+xattrs
/root/.ssh Checksums+p+i+n+u+g+s+b+acl+xattrs
/usr/bin Checksums+p+i+n+u+g+s+b+acl+xattrs
/usr/sbin Checksums+p+i+n+u+g+s+b+acl+xattrs
/bin Checksums+p+i+n+u+g+s+b+acl+xattrs
/sbin Checksums+p+i+n+u+g+s+b+acl+xattrs
EOF

log "AIDE configuration created with SHA256/SHA512 checksums. Initializing database (this may take a while)..."
aideinit 2>&1 | tee -a "$LOG_FILE" || log_warning "AIDE initialization will complete in background"

log "AIDE initialized. Database will be available at /var/lib/aide/aide.db"

###############################################################################
# 18. RKHUNTER CONFIGURATION
###############################################################################
log_section "18. Configuring Rootkit Hunter"

# Update rkhunter database (non-critical, may fail due to update server issues)
log "Attempting to update rkhunter database..."
if rkhunter --update 2>&1 | tee -a "$LOG_FILE"; then
    log "Rkhunter database updated successfully"
else
    log_warning "Rkhunter database update failed (non-critical - will use packaged version)"
fi

# Update file properties database
log "Updating rkhunter file properties..."
if rkhunter --propupd 2>&1 | tee -a "$LOG_FILE"; then
    log "Rkhunter properties updated successfully"
else
    log_warning "Rkhunter property update failed (non-critical)"
fi

log "Rootkit Hunter configured"

###############################################################################
# 19. DEBSUMS AUTOMATED CHECKING
###############################################################################
log_section "19. Configuring Debsums Automated Checks"

# Create debsums check script
cat > /usr/local/bin/debsums-check.sh << 'EOFSCRIPT'
#!/bin/bash
# Automated debsums integrity check

LOG_FILE="/var/log/debsums-check.log"
DATE=$(date +"%Y-%m-%d %H:%M:%S")

echo "[$DATE] Starting debsums integrity check..." >> "$LOG_FILE"
debsums -s >> "$LOG_FILE" 2>&1

if [ $? -eq 0 ]; then
    echo "[$DATE] Debsums check completed: All files verified" >> "$LOG_FILE"
else
    echo "[$DATE] WARNING: Debsums found modified files!" >> "$LOG_FILE"
fi
EOFSCRIPT

chmod +x /usr/local/bin/debsums-check.sh

# Add weekly cron job
cat > /etc/cron.weekly/debsums-check << 'EOF'
#!/bin/bash
/usr/local/bin/debsums-check.sh
EOF
chmod +x /etc/cron.weekly/debsums-check

log "Debsums automated checking configured (weekly)"

###############################################################################
# 20. SECURE SHARED MEMORY
###############################################################################
log_section "20. Securing Shared Memory"

# Backup fstab
if [ -f /etc/fstab ]; then
    cp /etc/fstab "$BACKUP_DIR/fstab.bak"
    log "Backed up /etc/fstab"
fi

# Add secure shared memory mount if not already present
if ! grep -q "tmpfs /run/shm tmpfs" /etc/fstab; then
    echo "tmpfs /run/shm tmpfs defaults,noexec,nodev,nosuid 0 0" >> /etc/fstab
    log "Secure shared memory configuration added to /etc/fstab"
else
    log "Secure shared memory already configured"
fi

###############################################################################
# 21. NETWORK HARDENING
###############################################################################
log_section "21. Additional Network Hardening"

# Disable IPv6 if not needed (configure via /etc/sysctl.d/99-security.conf)
# Already handled in section 3

# Configure TCP wrappers (if needed)
cat > /etc/hosts.allow << EOF
# Allow SSH from Cloudflare tunnel
sshd: $TUNNEL_IP
sshd: 127.0.0.1
EOF

cat > /etc/hosts.deny << 'EOF'
# Deny all by default
ALL: ALL
EOF

log "Network hardening completed"

###############################################################################
# 21.5 DNS SECURITY HARDENING
###############################################################################
log_section "21.5. Configuring DNS Security"

# Ensure hostname is resolvable (prevents sudo warnings)
CURRENT_HOSTNAME=$(hostname)
if ! grep -q "$CURRENT_HOSTNAME" /etc/hosts 2>/dev/null; then
    log "Adding hostname to /etc/hosts..."
    echo "127.0.1.1 $CURRENT_HOSTNAME" >> /etc/hosts
fi

# Check if cloudflared or cloudflare-warp is managing DNS
if grep -q "cloudflare" /etc/resolv.conf 2>/dev/null || \
   systemctl is-active --quiet cloudflared 2>/dev/null || \
   systemctl is-active --quiet warp-svc 2>/dev/null; then
    log "Cloudflare tunnel/WARP detected - preserving existing DNS configuration"
    log "DNS is managed by Cloudflare - skipping systemd-resolved setup"
else
    # Check if systemd-resolved is available
    if command -v systemd-resolve &> /dev/null || [ -f /lib/systemd/system/systemd-resolved.service ]; then
        log "Configuring systemd-resolved for secure DNS..."

        mkdir -p /etc/systemd/resolved.conf.d
        cat > /etc/systemd/resolved.conf.d/99-security.conf << 'EOF'
[Resolve]
# Use Cloudflare DNS with DNS-over-TLS
DNS=1.1.1.1#cloudflare-dns.com 1.0.0.1#cloudflare-dns.com
FallbackDNS=8.8.8.8#dns.google 8.8.4.4#dns.google

# Enable DNSSEC validation
DNSSEC=yes

# Enable DNS-over-TLS (DoT)
DNSOverTLS=yes

# Disable multicast DNS (attack surface reduction)
MulticastDNS=no

# Disable LLMNR (attack surface reduction)
LLMNR=no
EOF

        systemctl enable systemd-resolved 2>&1 | tee -a "$LOG_FILE"
        systemctl restart systemd-resolved 2>&1 | tee -a "$LOG_FILE"

        # Only link if systemd-resolved started successfully
        if systemctl is-active --quiet systemd-resolved; then
            if [ ! -L /etc/resolv.conf ] || [ "$(readlink /etc/resolv.conf)" != "/run/systemd/resolve/stub-resolv.conf" ]; then
                log "Linking /etc/resolv.conf to systemd-resolved..."
                ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
            fi
            log "DNS security configured (DNSSEC + DNS-over-TLS via Cloudflare)"
        else
            log_warning "systemd-resolved failed to start - using fallback DNS"
            echo -e "nameserver 1.1.1.1\nnameserver 8.8.8.8" > /etc/resolv.conf
        fi
    else
        log_warning "systemd-resolved not available - configuring static DNS"
        # Preserve existing resolv.conf if it works, otherwise set fallback
        if ! grep -q "nameserver" /etc/resolv.conf 2>/dev/null; then
            echo -e "nameserver 1.1.1.1\nnameserver 8.8.8.8" > /etc/resolv.conf
        fi
        log "Static DNS configured (Cloudflare 1.1.1.1)"
    fi
fi

###############################################################################
# 22. SYSTEM LIMITS CONFIGURATION
###############################################################################
log_section "22. Configuring System Limits"

# Configure limits
cat > /etc/security/limits.d/99-security.conf << 'EOF'
# Core dumps
* hard core 0

# Process limits
* hard nproc 512

# File limits
* hard nofile 65535
* soft nofile 65535
EOF

log "System limits configured"

###############################################################################
# 23. CREATE SECURITY MONITORING SCRIPT
###############################################################################
log_section "23. Creating Security Monitoring Script"

cat > /usr/local/bin/security-check.sh << 'EOFSCRIPT'
#!/bin/bash
# Daily security check script

echo "=== Daily Security Report - $(date) ===" > /tmp/security-report.txt
echo "" >> /tmp/security-report.txt

# Check for failed login attempts
echo "Failed Login Attempts (last 24 hours):" >> /tmp/security-report.txt
grep "Failed password" /var/log/auth.log | grep "$(date +'%b %e')" >> /tmp/security-report.txt || echo "None" >> /tmp/security-report.txt
echo "" >> /tmp/security-report.txt

# Check fail2ban status
echo "Fail2ban Status:" >> /tmp/security-report.txt
fail2ban-client status sshd >> /tmp/security-report.txt 2>&1 || echo "fail2ban not running" >> /tmp/security-report.txt
echo "" >> /tmp/security-report.txt

# Check for security updates
echo "Available Security Updates:" >> /tmp/security-report.txt
apt list --upgradable 2>/dev/null | grep -i security >> /tmp/security-report.txt || echo "None" >> /tmp/security-report.txt
echo "" >> /tmp/security-report.txt

# Check listening ports
echo "Listening Ports:" >> /tmp/security-report.txt
ss -tulpn >> /tmp/security-report.txt
echo "" >> /tmp/security-report.txt

# Check disk usage
echo "Disk Usage:" >> /tmp/security-report.txt
df -h >> /tmp/security-report.txt
echo "" >> /tmp/security-report.txt

# Display report
cat /tmp/security-report.txt

# Optionally email the report (configure email settings)
# mail -s "Security Report - $(hostname)" admin@example.com < /tmp/security-report.txt
EOFSCRIPT

chmod +x /usr/local/bin/security-check.sh

# Add to daily cron
cat > /etc/cron.daily/security-check << 'EOF'
#!/bin/bash
/usr/local/bin/security-check.sh >> /var/log/security-check.log 2>&1
EOF
chmod +x /etc/cron.daily/security-check

log "Security monitoring script created at /usr/local/bin/security-check.sh"

###############################################################################
# 23.5 LOG ROTATION CONFIGURATION
###############################################################################
log_section "23.5. Configuring Log Rotation for Security Logs"

# Create logrotate configuration for hardening-related logs
cat > /etc/logrotate.d/hardening-logs << 'EOF'
# UFW firewall logs
/var/log/ufw.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0600 root root
    sharedscripts
    postrotate
        /usr/sbin/service rsyslog rotate > /dev/null 2>&1 || true
    endscript
}

# Fail2ban logs
/var/log/fail2ban.log {
    weekly
    missingok
    rotate 12
    compress
    delaycompress
    notifempty
    create 0600 root root
    postrotate
        fail2ban-client flushlogs > /dev/null 2>&1 || true
    endscript
}

# Security check logs
/var/log/security-check.log {
    weekly
    missingok
    rotate 8
    compress
    delaycompress
    notifempty
    create 0600 root root
}

# Debsums check logs
/var/log/debsums-check.log {
    monthly
    missingok
    rotate 6
    compress
    delaycompress
    notifempty
    create 0600 root root
}
EOF

log "Log rotation configured for security logs"

###############################################################################
# 24. FINAL SECURITY CHECKS
###############################################################################
log_section "24. Running Final Security Checks"

# Check for SUID/SGID files (scan common system directories only for speed)
log "Scanning for SUID/SGID files in system directories..."
find /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null > "$BACKUP_DIR/suid-sgid-files.txt" || true
log "SUID/SGID files saved to $BACKUP_DIR/suid-sgid-files.txt"

# Check for world-writable files (common directories only)
log "Scanning for world-writable files in /tmp and /var/tmp..."
find /tmp /var/tmp -type f -perm -002 2>/dev/null | head -20 > "$BACKUP_DIR/world-writable-files.txt" || true
log "World-writable files saved to $BACKUP_DIR/world-writable-files.txt"

# Check for files with no owner (common directories only)
log "Scanning for files with no owner in home and opt directories..."
find /home /opt /usr/local -nouser -o -nogroup 2>/dev/null | head -50 > "$BACKUP_DIR/no-owner-files.txt" || true
log "Files with no owner saved to $BACKUP_DIR/no-owner-files.txt"

###############################################################################
# 24.5 LYNIS SECURITY AUDIT
###############################################################################
log_section "24.5. Running Lynis Security Audit"

# Run Lynis quick audit and save baseline
log "Running Lynis security audit (quick mode)..."
if command -v lynis &> /dev/null; then
    lynis audit system --quick --no-colors 2>&1 | tee "$BACKUP_DIR/lynis-audit.txt" | tail -30
    log "Lynis audit completed. Full report saved to: $BACKUP_DIR/lynis-audit.txt"

    # Extract hardening index
    HARDENING_INDEX=$(grep "Hardening index" "$BACKUP_DIR/lynis-audit.txt" | tail -1 || echo "Not available")
    log "Lynis $HARDENING_INDEX"
else
    log_warning "Lynis not found. Skipping security audit."
fi

###############################################################################
# 25. GENERATE SECURITY REPORT
###############################################################################
log_section "25. Generating Security Report"

REPORT_FILE="$BACKUP_DIR/hardening-report.txt"

cat > "$REPORT_FILE" << EOF
================================================================================
VPS Security Hardening Report
Generated: $(date)
Hostname: $(hostname)
================================================================================

CONFIGURATION SUMMARY:
- Cloudflare Tunnel IP: $TUNNEL_IP
- SSH Port: 22 (listening on $TUNNEL_IP only)
- Firewall: UFW (enabled)
- Intrusion Prevention: Fail2ban (enabled)
- Mandatory Access Control: AppArmor (enabled)
- Audit System: auditd (enabled)
- File Integrity: AIDE (initialized)
- DNS Security: DNSSEC + DNS-over-TLS (Cloudflare)
- IPv6: Disabled
- Automatic Updates: Enabled (security updates only)

BACKUP LOCATION: $BACKUP_DIR
LOG FILE: $LOG_FILE

INSTALLED SECURITY PACKAGES:
$(dpkg -l | grep -E '^ii' | grep -E '(ufw|fail2ban|apparmor|auditd|aide|lynis|rkhunter)' | awk '{print "- " $2 " (" $3 ")"}')

FIREWALL STATUS:
$(ufw status verbose)

FAIL2BAN STATUS:
$(fail2ban-client status)

APPARMOR STATUS:
$(aa-status 2>&1 | head -20)

LISTENING SERVICES:
$(ss -tulpn)

IMPORTANT NEXT STEPS:
1. Review SSH configuration: /etc/ssh/sshd_config.d/99-hardening.conf
2. Test SSH connection BEFORE logging out: ssh -i <key> user@<tunnel-ip>
3. Review firewall rules: ufw status verbose
4. Configure email alerts for fail2ban
5. Schedule regular AIDE checks: aide --check
6. Review audit logs: ausearch -k <keyword>
7. Run security scan: lynis audit system
8. Monitor logs: tail -f /var/log/auth.log
9. Check security reports: /usr/local/bin/security-check.sh

BACKUP FILES LOCATION:
All original configuration files have been backed up to: $BACKUP_DIR

RECOMMENDED WEEKLY TASKS:
- Run: lynis audit system
- Check: aide --check
- Review: /var/log/auth.log
- Review: fail2ban-client status
- Update: rkhunter --update && rkhunter --check

================================================================================
HARDENING COMPLETE
================================================================================
EOF

cat "$REPORT_FILE"

log "Security report saved to: $REPORT_FILE"

###############################################################################
# 26. RESTART SERVICES
###############################################################################
log_section "26. Restarting Services"

log_warning "About to restart SSH. Ensure you have another way to access the system!"
log "Press Ctrl+C within 10 seconds to cancel SSH restart..."
sleep 10

systemctl restart ssh 2>&1 | tee -a "$LOG_FILE"
log "SSH service restarted"

###############################################################################
# COMPLETION
###############################################################################
log_section "HARDENING COMPLETED SUCCESSFULLY"

echo ""
log "========================================="
log "VPS HARDENING COMPLETE!"
log "========================================="
log ""
log "IMPORTANT: Test SSH access NOW before logging out!"
log "Command: ssh -i <your-key> user@server (via tunnel)"
log ""
log "Backup location: $BACKUP_DIR"
log "Full report: $REPORT_FILE"
log "Log file: $LOG_FILE"
log ""
log "Run security check: /usr/local/bin/security-check.sh"
log "Run security audit: lynis audit system"
log ""
log_warning "REBOOT RECOMMENDED to ensure all changes take effect"
log "========================================="

exit 0
